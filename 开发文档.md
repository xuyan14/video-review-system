# 视频审核管理系统 - 开发文档

## 1. 技术架构

### 1.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (HTML)   │    │   后端 (Flask)  │    │   数据库 (SQLite)│
│                 │    │                 │    │                 │
│  - Bootstrap 5  │◄──►│  - Python Flask │◄──►│  - SQLite3      │
│  - JavaScript   │    │  - RESTful API  │    │  - 关系型数据库  │
│  - CSS3         │    │  - 文件上传     │    │  - 事务支持      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术栈
- **前端**：HTML5 + CSS3 + JavaScript + Bootstrap 5
- **后端**：Python 3.9+ + Flask + SQLite3
- **数据库**：SQLite3
- **文件存储**：本地文件系统
- **开发环境**：Python虚拟环境

## 2. 项目结构

```
video_review_system/
├── start_simple.py              # Flask应用主文件
├── templates/
│   └── index.html              # 前端页面模板
├── requirements.txt             # Python依赖包
├── video_review.db             # SQLite数据库文件
├── screenshots/                # 截图文件存储目录
├── uploads/                    # 上传文件存储目录
├── init_database.py            # 数据库初始化脚本
├── import_excel_data.py        # Excel数据导入脚本
├── add_artwork_video_field.py  # 数据库字段添加脚本
├── add_screenshots_table.py    # 截图表创建脚本
└── 工作簿3.xlsx               # 原始Excel数据文件
```

## 3. 数据库设计

### 3.1 表结构

#### 3.1.1 video_projects 表
```sql
CREATE TABLE video_projects (
    id TEXT PRIMARY KEY,
    video_name TEXT NOT NULL,
    video_url TEXT NOT NULL,
    artwork_video_url TEXT,
    brand TEXT,
    category TEXT,
    material_name TEXT,
    material_price REAL,
    selling_points TEXT,
    product_id TEXT,
    product_link TEXT,
    selection_date TEXT,
    provide_date TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.2 workflow_status 表
```sql
CREATE TABLE workflow_status (
    id TEXT PRIMARY KEY,
    project_id TEXT NOT NULL,
    current_stage TEXT,
    completion_status TEXT,
    annotation_reviewer TEXT,
    ued_reviewer TEXT,
    artwork_person TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES video_projects (id)
);
```

#### 3.1.3 review_records 表
```sql
CREATE TABLE review_records (
    id TEXT PRIMARY KEY,
    project_id TEXT NOT NULL,
    review_type TEXT NOT NULL,
    reviewer_name TEXT,
    review_status TEXT,
    problem_description TEXT,
    review_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES video_projects (id)
);
```

#### 3.1.4 screenshots 表
```sql
CREATE TABLE screenshots (
    id TEXT PRIMARY KEY,
    project_id TEXT NOT NULL,
    review_type TEXT NOT NULL,
    screenshot_path TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES video_projects (id)
);
```

### 3.2 数据库关系
- `video_projects` ←→ `workflow_status` (1:1)
- `video_projects` ←→ `review_records` (1:N)
- `video_projects` ←→ `screenshots` (1:N)

## 4. API接口设计

### 4.1 项目相关接口

#### GET /api/projects
获取项目列表
```json
{
  "query_params": {
    "status": "string",
    "stage": "string", 
    "reviewer": "string",
    "brand": "string",
    "provideDate": "string",
    "productId": "string",
    "annotationStatus": "string",
    "uedStatus": "string"
  },
  "response": [
    {
      "id": "string",
      "video_name": "string",
      "video_url": "string",
      "artwork_video_url": "string",
      "annotation_reviewer": "string",
      "ued_reviewer": "string",
      "annotation_status": "string",
      "ued_status": "string",
      "annotation_screenshots": [],
      "ued_screenshots": []
    }
  ]
}
```

#### GET /api/statistics
获取统计数据
```json
{
  "response": {
    "total": 146,
    "pending_annotation": 10,
    "pending_artwork": 40,
    "pending_ued": 0,
    "completed": 3,
    "failed": 93
  }
}
```

### 4.2 审核相关接口

#### POST /api/update-reviewer
更新审核员
```json
{
  "request": {
    "videoId": "string",
    "reviewer": "string"
  },
  "response": {
    "message": "审核员已更新"
  }
}
```

#### POST /api/toggle-status
切换审核状态
```json
{
  "request": {
    "videoId": "string",
    "type": "annotation|ued",
    "status": "可用|不可用",
    "reviewer": "string",
    "comment": "string"
  },
  "response": {
    "message": "状态已更新"
  }
}
```

#### POST /api/save-screenshot
保存截图
```json
{
  "request": {
    "videoId": "string",
    "reviewType": "annotation|ued",
    "screenshotData": "base64_string"
  },
  "response": {
    "message": "截图保存成功",
    "screenshot_path": "string"
  }
}
```

### 4.3 文件相关接口

#### POST /api/upload-artwork-video
上传加艺术字视频
```json
{
  "request": "multipart/form-data",
  "fields": {
    "videoFile": "file",
    "videoId": "string"
  },
  "response": {
    "message": "视频上传成功",
    "video_url": "string"
  }
}
```

#### GET /uploads/<filename>
获取上传文件
#### GET /screenshots/<filename>
获取截图文件

## 5. 前端架构

### 5.1 页面结构
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>视频审核管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- 筛选区域 -->
    <div class="filter-section">...</div>
    
    <!-- 操作按钮区域 -->
    <div class="action-section">...</div>
    
    <!-- 数据表格区域 -->
    <div class="table-section">...</div>
    
    <!-- 审核模态框 -->
    <div class="modal" id="reviewModal">...</div>
    
    <!-- 上传模态框 -->
    <div class="modal" id="uploadModal">...</div>
    
    <!-- 列设置模态框 -->
    <div class="modal" id="columnSettingsModal">...</div>
</body>
</html>
```

### 5.2 JavaScript模块

#### 5.2.1 数据管理模块
```javascript
// 全局变量
let currentVideos = [];
let columnSettings = {
    available: [...],
    selected: [...]
};

// 数据加载
async function loadVideos() { ... }
async function loadStatistics() { ... }
```

#### 5.2.2 表格渲染模块
```javascript
// 表格渲染
function renderVideosTable() { ... }
function renderTableHeader() { ... }
function getColumnContent(video, columnId) { ... }
```

#### 5.2.3 审核功能模块
```javascript
// 审核相关
function openReviewModal(videoId, videoType) { ... }
function captureFrame() { ... }
async function submitReview() { ... }
```

#### 5.2.4 文件上传模块
```javascript
// 文件上传
function openUploadModal(videoId) { ... }
async function uploadArtworkVideo() { ... }
```

## 6. 核心功能实现

### 6.1 审核工作流实现

#### 6.1.1 状态判断逻辑
```javascript
function getStageIndicator(video) {
    const annotationStatus = video.annotation_status;
    const uedStatus = video.ued_status;
    const hasArtworkVideo = video.artwork_video_url && video.artwork_video_url !== '';
    
    if (!annotationStatus || annotationStatus === '未审核') {
        return '待标注审核';
    } else if (annotationStatus === '不可用') {
        return '标注审核不通过';
    } else if (annotationStatus === '可用' && !hasArtworkVideo) {
        return '待加艺术字';
    } else if (annotationStatus === '可用' && hasArtworkVideo && (!uedStatus || uedStatus === '未审核')) {
        return '待UED审核';
    } else if (uedStatus === '可用') {
        return 'UED审核通过';
    } else if (uedStatus === '不可用') {
        return 'UED审核不通过';
    }
}
```

#### 6.1.2 加艺术字视频显示逻辑
```javascript
function getArtworkVideo(video) {
    const annotationStatus = video.annotation_status;
    
    // 如果标注审核状态为"不可用"，则显示"--"
    if (annotationStatus === '不可用') {
        return '<span class="text-muted">--</span>';
    }
    
    // 如果标注审核状态为"未审核"或null，显示"--"（不显示上传按钮）
    if (annotationStatus === '未审核' || !annotationStatus || annotationStatus === null) {
        return '<span class="text-muted">--</span>';
    }
    
    // 如果已上传加艺术字视频，显示播放按钮
    if (video.artwork_video_url && video.artwork_video_url !== '') {
        return '<i class="fas fa-eye text-primary" onclick="openReviewModal(\'' + video.id + '\', \'artwork\')"></i>';
    }
    
    // 否则显示上传按钮
    return '<button class="btn btn-sm btn-outline-primary" onclick="openUploadModal(\'' + video.id + '\')">上传视频</button>';
}
```

### 6.2 截图功能实现

#### 6.2.1 前端截图逻辑
```javascript
function captureFrame() {
    const video = document.getElementById('reviewVideo');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    const imageData = canvas.toDataURL('image/png');
    addScreenshot('screenshot_' + Date.now(), imageData);
}
```

#### 6.2.2 后端截图保存
```python
@app.route('/api/save-screenshot', methods=['POST'])
def save_screenshot():
    video_id = request.form.get('videoId')
    review_type = request.form.get('reviewType')
    screenshot_data = request.form.get('screenshotData')
    
    # 生成文件名
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f"screenshot_{video_id}_{review_type}_{timestamp}.png"
    file_path = os.path.join('screenshots', filename)
    
    # 保存base64图片
    if screenshot_data.startswith('data:image'):
        screenshot_data = screenshot_data.split(',')[1]
    
    with open(file_path, 'wb') as f:
        f.write(base64.b64decode(screenshot_data))
    
    # 保存到数据库
    conn = get_db_connection()
    conn.execute("""
        INSERT INTO screenshots (id, project_id, review_type, screenshot_path, created_at)
        VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
    """, (str(uuid.uuid4()), video_id, review_type, f"/screenshots/{filename}"))
    conn.commit()
    conn.close()
    
    return jsonify({'message': '截图保存成功'})
```

### 6.3 列设置功能实现

#### 6.3.1 列配置管理
```javascript
const columnSettings = {
    available: [
        { id: 'checkbox', name: '选择', required: true },
        { id: 'material_info', name: '素材信息', required: true },
        { id: 'brand', name: '品牌信息', required: false },
        { id: 'category', name: '品类', required: false },
        { id: 'product_info', name: '商品信息', required: false },
        { id: 'video_dates', name: '视频日期', required: false },
        { id: 'original_video', name: '原始生产视频', required: true },
        { id: 'artwork_video', name: '加艺术字视频', required: true },
        { id: 'reviewer', name: '审核员', required: true },
        { id: 'annotation_status', name: '标注验收状态', required: true },
        { id: 'artwork_person', name: '加艺术字人员', required: true },
        { id: 'ued_status', name: 'UED验收状态', required: true },
        { id: 'current_stage', name: '当前阶段', required: true },
        { id: 'annotation_comment', name: '标注审核意见', required: false },
        { id: 'annotation_screenshots', name: '标注审核截图', required: false },
        { id: 'ued_comment', name: 'UED审核意见', required: false },
        { id: 'ued_screenshots', name: 'UED审核截图', required: false },
        { id: 'production_details', name: '生产详情', required: false }
    ],
    selected: ['checkbox', 'material_info', 'brand', 'category', 'product_info', 'video_dates', 'original_video', 'artwork_video', 'reviewer', 'annotation_status', 'artwork_person', 'ued_status', 'current_stage']
};
```

#### 6.3.2 动态表格渲染
```javascript
function renderVideosTable() {
    renderTableHeader();
    
    const tbody = document.getElementById('videosTable');
    tbody.innerHTML = '';
    
    currentVideos.forEach(video => {
        const row = document.createElement('tr');
        row.dataset.videoId = video.id;
        
        columnSettings.selected.forEach(columnId => {
            const cell = document.createElement('td');
            cell.innerHTML = getColumnContent(video, columnId);
            row.appendChild(cell);
        });
        
        tbody.appendChild(row);
    });
}
```

## 7. 部署说明

### 7.1 环境要求
- Python 3.9+
- SQLite3
- 现代浏览器（Chrome 80+, Firefox 75+, Safari 13+, Edge 80+）

### 7.2 安装步骤

#### 7.2.1 创建虚拟环境
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows
```

#### 7.2.2 安装依赖
```bash
pip install -r requirements.txt
```

#### 7.2.3 初始化数据库
```bash
python init_database.py
python import_excel_data.py
python add_artwork_video_field.py
python add_screenshots_table.py
```

#### 7.2.4 启动应用
```bash
python start_simple.py
```

### 7.3 配置说明

#### 7.3.1 数据库配置
- 数据库文件：`video_review.db`
- 自动创建表结构
- 支持事务操作

#### 7.3.2 文件存储配置
- 截图存储：`screenshots/` 目录
- 视频上传：`uploads/` 目录
- 支持大文件上传

#### 7.3.3 服务器配置
- 默认端口：3000
- 调试模式：开启
- 自动重载：开启

## 8. 开发规范

### 8.1 代码规范
- Python代码遵循PEP 8规范
- JavaScript代码使用ES6+语法
- HTML使用语义化标签
- CSS使用Bootstrap 5框架

### 8.2 命名规范
- 数据库表名：下划线命名法（snake_case）
- 变量名：驼峰命名法（camelCase）
- 函数名：动词开头，描述性命名
- 文件名：下划线命名法（snake_case）

### 8.3 注释规范
- 函数注释：说明功能、参数、返回值
- 复杂逻辑注释：解释业务逻辑
- API接口注释：说明请求参数和响应格式

## 9. 测试说明

### 9.1 功能测试
- 视频列表加载测试
- 审核流程测试
- 文件上传测试
- 截图功能测试

### 9.2 性能测试
- 页面加载性能测试
- 数据库查询性能测试
- 文件上传性能测试

### 9.3 兼容性测试
- 浏览器兼容性测试
- 设备兼容性测试
- 分辨率适配测试

## 10. 维护说明

### 10.1 日志管理
- 应用日志：Flask内置日志
- 错误日志：异常捕获和记录
- 操作日志：用户操作记录

### 10.2 数据备份
- 数据库备份：定期备份SQLite文件
- 文件备份：定期备份上传文件
- 配置备份：备份系统配置文件

### 10.3 性能监控
- 响应时间监控
- 内存使用监控
- 磁盘空间监控

## 11. 扩展开发

### 11.1 功能扩展
- 支持更多审核类型
- 支持自定义审核流程
- 支持批量操作优化

### 11.2 技术升级
- 数据库升级（PostgreSQL/MySQL）
- 缓存系统集成（Redis）
- 消息队列集成（Celery）

### 11.3 部署优化
- Docker容器化部署
- Nginx反向代理
- 负载均衡配置
